{% extends "base.html" %}

{% block title %}Dashboard - AutoHire{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Welcome Section -->
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-light">Welcome back, {{ current_user.username }}!</h1>
                    <p class="text-secondary mb-0 ">Here's what's happening with your job applications</p>
                </div>
                <div>
                    <button class="btn btn-success me-2" onclick="startAutomation()">
                        <i class="fas fa-play me-1"></i>Start Automation
                    </button>
                    <button class="btn btn-outline-danger" onclick="stopAutomation()">
                        <i class="fas fa-stop me-1"></i>Stop
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card border-0 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-primary">
                            <i class="fas fa-file-alt text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h2 class="h4 mb-0 fw-bold text-light">{{ total_applications }}</h2>
                            <p class="text-light mb-0">Total Applications</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card border-0 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-info">
                            <i class="fas fa-calendar-day text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h2 class="h4 mb-0 fw-bold text-light">{{ applications_today }}</h2>
                            <p class=" mb-0 text-light">Applied Today</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card border-0 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-success">
                            <i class="fas fa-handshake text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h2 class="h4 mb-0 fw-bold text-light">{{ status_data.interview + status_data.hired }}</h2>
                            <p class=" mb-0 text-light">Interviews/Hired</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stats-card border-0 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-warning">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h2 class="h4 mb-0 fw-bold text-light">{{ recent_applications }}</h2>
                            <p class="text-light mb-0">Last 30 Days</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Application Status Chart -->
        <div class="col-xl-8">
            <div class="card border-0 h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">Application Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="statusChart" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="status-legend">
                                <div class="legend-item">
                                    <span class="legend-color bg-primary"></span>
                                    <span>Applied ({{ status_data.applied }})</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color bg-success"></span>
                                    <span>Interview ({{ status_data.interview }})</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color bg-warning"></span>
                                    <span>Hired ({{ status_data.hired }})</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color bg-danger"></span>
                                    <span>Rejected ({{ status_data.rejected }})</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color bg-secondary"></span>
                                    <span>Error ({{ status_data.error }})</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Platform Statistics -->
        <div class="col-xl-4">
            <div class="card border-0 h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">Platform Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="platform-stats">
                        {% for platform, count in platform_data.items() %}
                        <div class="platform-item d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                {% if platform == 'linkedin' %}
                                    <i class="fab fa-linkedin text-primary me-2"></i>
                                {% elif platform == 'indeed' %}
                                    <i class="fas fa-briefcase text-info me-2"></i>
                                {% elif platform == 'naukri' %}
                                    <i class="fas fa-user-tie text-warning me-2"></i>
                                {% elif platform == 'internshala' %}
                                    <i class="fas fa-graduation-cap text-success me-2"></i>
                                {% endif %}
                                <span class="text-capitalize">{{ platform }}</span>
                            </div>
                            <span class="badge bg-light text-dark">{{ count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Applications -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card card-des text-light border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Recent Applications</h5>
                    <a href="{{ url_for('dashboard.applications') }}" class="btn btn-outline-primary btn-sm">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if recent_apps %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Job Title</th>
                                    <th>Company</th>
                                    <th>Platform</th>
                                    <th>Status</th>
                                    <th>Applied Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in recent_apps %}
                                <tr>
                                    <td>
                                        <strong>{{ app.job_title }}</strong>
                                        {% if app.work_type %}
                                        <small class="text-light d-block">{{ app.work_type.title() }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ app.company_name or 'N/A' }}</td>
                                    <td>
                                        <span class="badge badge-platform badge-{{ app.platform }}">
                                            {{ app.platform.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge status-badge status-{{ app.status }}">
                                            {{ app.status.title() }}
                                        </span>
                                    </td>
                                    <td>{{ app.application_date.strftime('%b %d, %Y') if app.application_date else 'N/A' }}</td>
                                    <td>
                                        <a href="{{ url_for('dashboard.application_detail', id=app.id) }}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-3x text-light mb-3"></i>
                        <h5 class="text-light">No applications yet</h5>
                        <p class="text-light">Start the automation to begin applying to jobs!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-card {
    background: rgb(60,60,60);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    transition: transform 0.2s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background:var(--main-content);
    color: white;
}

.status-legend {
    padding: 20px 0;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    margin-right: 12px;
}

.card{
    background: rgb(40,40,40);
    color: white;
}

.platform-item {
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.platform-item:last-child {
    border-bottom: none;
}

.badge-platform {
    font-size: 0.75rem;
    padding: 4px 8px;
}

.badge-linkedin { background-color: #0077b5; color: white; }
.badge-indeed { background-color: #2164f3; color: white; }
.badge-naukri { background-color: #ff6b35; color: white; }
.badge-internshala { background-color: #00d4aa; color: white; }

.status-badge {
    font-size: 0.75rem;
    padding: 4px 8px;
}

.status-applied { background-color: #007bff; color: white; }
.status-interview { background-color: #28a745; color: white; }
.status-hired { background-color: #ffc107; color: black; }
.status-rejected { background-color: #dc3545; color: white; }
.status-error { background-color: #6c757d; color: white; }

.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
}

.card-des {
    background: rgb(50,50,50);
    color: white;
}

</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Status Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Applied', 'Interview', 'Hired', 'Rejected', 'Error'],
        datasets: [{
            data: [
                {{ status_data.applied }},
                {{ status_data.interview }},
                {{ status_data.hired }},
                {{ status_data.rejected }},
                {{ status_data.error }}
            ],
            backgroundColor: [
                '#007bff',
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#6c757d'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Automation control variables
let automationStatusInterval = null;
let isAutomationRunning = false;

// Initialize automation status checking when page loads
document.addEventListener('DOMContentLoaded', function() {
    checkAutomationStatus();
    startStatusPolling();
});

function startAutomation() {
    if (confirm('Are you sure you want to start the automation process? This will begin applying to jobs automatically.')) {
        // Show loading state
        const startBtn = document.querySelector('[onclick="startAutomation()"]');
        const stopBtn = document.querySelector('[onclick="stopAutomation()"]');
        const originalText = startBtn.innerHTML;
        
        startBtn.innerHTML = '\u003ci class="fas fa-spinner fa-spin me-1"\u003e\u003c/i\u003eStarting...';
        startBtn.disabled = true;
        
        fetch('{{ url_for("dashboard.start_automation_process") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                isAutomationRunning = true;
                
                // Update button states
                startBtn.innerHTML = '\u003ci class="fas fa-play me-1"\u003e\u003c/i\u003eRunning...';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                // Start frequent status polling
                startStatusPolling(2000); // Check every 2 seconds when running
                
            } else {
                showAlert(data.message, 'error');
                
                // Reset button state
                startBtn.innerHTML = originalText;
                startBtn.disabled = false;
                
                // Redirect if needed
                if (data.redirect) {
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 2000);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to start automation. Please try again.', 'error');
            
            // Reset button state
            startBtn.innerHTML = originalText;
            startBtn.disabled = false;
        });
    }
}

function stopAutomation() {
    if (confirm('Are you sure you want to stop the automation process?')) {
        const stopBtn = document.querySelector('[onclick="stopAutomation()"]');
        const originalText = stopBtn.innerHTML;
        
        stopBtn.innerHTML = '\u003ci class="fas fa-spinner fa-spin me-1"\u003e\u003c/i\u003eStopping...';
        stopBtn.disabled = true;
        
        fetch('{{ url_for("dashboard.stop_automation_process") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'info');
                isAutomationRunning = false;
                
                // Reset buttons after a delay
                setTimeout(() => {
                    const startBtn = document.querySelector('[onclick="startAutomation()"]');
                    startBtn.innerHTML = '\u003ci class="fas fa-play me-1"\u003e\u003c/i\u003eStart Automation';
                    startBtn.disabled = false;
                    
                    stopBtn.innerHTML = '\u003ci class="fas fa-stop me-1"\u003e\u003c/i\u003eStop';
                    stopBtn.disabled = true;
                }, 1000);
                
                // Slow down status polling
                startStatusPolling(10000); // Check every 10 seconds when stopped
                
            } else {
                showAlert(data.message, 'warning');
                stopBtn.innerHTML = originalText;
                stopBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to stop automation. Please try again.', 'error');
            stopBtn.innerHTML = originalText;
            stopBtn.disabled = false;
        });
    }
}

function checkAutomationStatus() {
    fetch('{{ url_for("dashboard.automation_status") }}')
        .then(response => response.json())
        .then(status => {
            updateAutomationUI(status);
        })
        .catch(error => {
            console.error('Error checking automation status:', error);
        });
}

function updateAutomationUI(status) {
    const startBtn = document.querySelector('[onclick="startAutomation()"]');
    const stopBtn = document.querySelector('[onclick="stopAutomation()"]');
    
    // Create or update status display
    let statusDisplay = document.getElementById('automation-status');
    if (!statusDisplay) {
        // Create status display if it doesn't exist
        statusDisplay = document.createElement('div');
        statusDisplay.id = 'automation-status';
        statusDisplay.className = 'alert alert-info mt-3';
        statusDisplay.style.display = 'none';
        
        // Insert after the buttons
        const buttonContainer = startBtn.parentElement;
        buttonContainer.parentElement.appendChild(statusDisplay);
    }
    
    if (status.active) {
        isAutomationRunning = true;
        
        // Update button states
        startBtn.innerHTML = '\u003ci class="fas fa-play me-1"\u003e\u003c/i\u003eRunning...';
        startBtn.disabled = true;
        stopBtn.disabled = false;
        
        // Show status display
        statusDisplay.className = 'alert alert-info mt-3';
        statusDisplay.style.display = 'block';
        statusDisplay.innerHTML = `
            \u003cdiv class="d-flex justify-content-between align-items-center"\u003e
                \u003cdiv\u003e
                    \u003ci class="fas fa-robot me-2"\u003e\u003c/i\u003e
                    \u003cstrong\u003eAutomation Active\u003c/strong\u003e
                    \u003cbr\u003e
                    \u003csmall\u003e${status.current_action}\u003c/small\u003e
                \u003c/div\u003e
                \u003cdiv class="text-end"\u003e
                    \u003cdiv\u003e\u003csmall\u003eApplications: ${status.applications_made}\u003c/small\u003e\u003c/div\u003e
                    \u003cdiv\u003e\u003csmall\u003eSearched: ${status.total_searched}\u003c/small\u003e\u003c/div\u003e
                \u003c/div\u003e
            \u003c/div\u003e
        `;
        
    } else {
        isAutomationRunning = false;
        
        // Update button states
        startBtn.innerHTML = '\u003ci class="fas fa-play me-1"\u003e\u003c/i\u003eStart Automation';
        startBtn.disabled = false;
        stopBtn.innerHTML = '\u003ci class="fas fa-stop me-1"\u003e\u003c/i\u003eStop';
        stopBtn.disabled = true;
        
        // Hide or update status display based on status
        if (status.status === 'completed') {
            statusDisplay.className = 'alert alert-success mt-3';
            statusDisplay.style.display = 'block';
            statusDisplay.innerHTML = `
                \u003ci class="fas fa-check-circle me-2"\u003e\u003c/i\u003e
                \u003cstrong\u003eAutomation Completed!\u003c/strong\u003e
                Applied to ${status.applications_made} jobs.
            `;
            
            // Hide after 10 seconds
            setTimeout(() => {
                statusDisplay.style.display = 'none';
            }, 10000);
            
        } else if (status.status === 'stopped') {
            statusDisplay.className = 'alert alert-warning mt-3';
            statusDisplay.style.display = 'block';
            statusDisplay.innerHTML = `
                \u003ci class="fas fa-pause-circle me-2"\u003e\u003c/i\u003e
                \u003cstrong\u003eAutomation Stopped\u003c/strong\u003e
                ${status.current_action}
            `;
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDisplay.style.display = 'none';
            }, 5000);
            
        } else {
            statusDisplay.style.display = 'none';
        }
    }
}

function startStatusPolling(interval = 10000) {
    // Clear existing interval
    if (automationStatusInterval) {
        clearInterval(automationStatusInterval);
    }
    
    // Start new interval
    automationStatusInterval = setInterval(checkAutomationStatus, interval);
}

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        \u003cbutton type="button" class="btn-close" data-bs-dismiss="alert"\u003e\u003c/button\u003e
    `;
    
    // Add to body
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
